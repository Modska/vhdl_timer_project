name: VHDL_CI_with_Formal
on: [push, pull_request]

jobs:
  # Job 1: Simulation tests with VUnit
  simulation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install GHDL and VUnit
        run: |
          sudo apt-get update
          sudo apt-get install -y ghdl
          pip install vunit_hdl
      
      - name: Run VUnit Tests
        run: python run.py
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vunit-test-results
          path: vunit_out/

  # Job 2: Formal verification with SymbiYosys (Stretch Goal)
  formal:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ghdl
      
      - name: Install OSS CAD Suite
        run: |
          wget -q https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2024-12-18/oss-cad-suite-linux-x64-20241218.tgz
          tar -xzf oss-cad-suite-linux-x64-20241218.tgz
      
      - name: Run Formal Verification - BMC
        continue-on-error: true
        run: |
          source oss-cad-suite/environment
          cd formal
          sby -f timer.sby bmc
      
      - name: Run Formal Verification - Prove
        continue-on-error: true
        run: |
          source oss-cad-suite/environment
          cd formal
          sby -f timer.sby prove
      
      - name: Run Formal Verification - Cover
        continue-on-error: true
        run: |
          source oss-cad-suite/environment
          cd formal
          sby -f timer.sby cover
      
      - name: Check Status
        run: |
          cd formal
          [ -f timer_bmc/status ] && echo "BMC: $(cat timer_bmc/status)"
          [ -f timer_prove/status ] && echo "Prove: $(cat timer_prove/status)"
      
      - name: Upload Formal Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-verification-results
          path: formal/timer_*/

  # Job 3: Summary Report
  report:
    needs: [simulation, formal]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate Summary
        run: |
          echo "# ðŸ“‹ Project Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ§ª VUnit Simulation" >> $GITHUB_STEP_SUMMARY
          if [ -d "vunit-test-results" ]; then
            echo "âœ… Simulation completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Simulation results missing." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ›¡ï¸ Formal Verification" >> $GITHUB_STEP_SUMMARY
          if [ -d "formal-verification-results" ]; then
            echo "âœ… Formal results available." >> $GITHUB_STEP_SUMMARY
            # Affiche le statut BMC si disponible
            if [ -f "formal-verification-results/timer_bmc/status" ]; then
               echo "**BMC Status:** $(cat formal-verification-results/timer_bmc/status)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Formal results not found." >> $GITHUB_STEP_SUMMARY
          fi