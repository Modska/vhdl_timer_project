name: VHDL_CI_with_Formal

# Trigger the workflow on every push or pull request to the repository
on: [push, pull_request]

jobs:
  # Job 1: Run functional simulation tests using VUnit and GHDL
  simulation:
    name: Functional Simulation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Install GHDL and VUnit
        run: |
          sudo apt-get update
          sudo apt-get install -y ghdl
          pip install vunit_hdl
      
      - name: Execute VUnit Test Suite
        run: python run.py
      
      - name: Archive Simulation Artifacts
        if: always() # Ensure results are uploaded even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: vunit-test-results
          path: vunit_out/

  # Job 2: Perform Formal Verification using SymbiYosys (SBY)
  formal:
    name: Formal Verification
    runs-on: ubuntu-latest
    continue-on-error: true # Allow flow to continue to report even if a proof fails
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install OSS CAD Suite (Yosys, SBY, GHDL-plugin)
        run: |
          wget -q https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2024-12-18/oss-cad-suite-linux-x64-20241218.tgz
          tar -xzf oss-cad-suite-linux-x64-20241218.tgz

      - name: Run SBY Tasks (BMC, Prove, Cover)
        run: |
          source oss-cad-suite/environment
          export YOSYS="yosys -m ghdl" 
          cd formal
          sby -f timer.sby bmc
          sby -f timer.sby prove
          sby -f timer.sby cover

      - name: Log Task Status to Console
        run: |
          [ -f formal/timer_bmc/status ] && echo "BMC: $(cat formal/timer_bmc/status)"
          [ -f formal/timer_prove/status ] && echo "Prove: $(cat formal/timer_prove/status)"
          [ -f formal/timer_cover/status ] && echo "Cover: $(cat formal/timer_cover/status)"
      
      - name: Archive Formal Verification Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formal-verification-results
          path: formal/timer_*/

  # Job 3: Consolidate results into a GitHub Step Summary
  report:
    name: Generation of Summary Report
    needs: [simulation, formal] # Wait for previous jobs to complete
    runs-on: ubuntu-latest
    if: always() # Always generate the report to see what passed/failed
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Retrieve All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Markdown Summary
        run: |
          echo "# ðŸ“‹ Project Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ§ª VUnit Simulation" >> $GITHUB_STEP_SUMMARY
          if [ -d "vunit-test-results" ]; then
            echo "âœ… Simulation tests completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Simulation results are missing or job failed." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ›¡ï¸ Formal Verification (SBY) Status" >> $GITHUB_STEP_SUMMARY
          echo "| Verification Task | Result |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          # Iterate through formal tasks and format results into a Markdown table
          for task in bmc prove cover; do
            STATUS_FILE="formal-verification-results/timer_$task/status"
            
            if [ -f "$STATUS_FILE" ]; then
              # Extract the primary status (first word) from the status file
              RAW_STATUS=$(head -n 1 "$STATUS_FILE" | awk '{print $1}')
              
              if [ "$RAW_STATUS" = "PASS" ]; then
                echo "| $task | âœ… PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $task | âŒ $RAW_STATUS |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $task | âš ï¸ Results Not Found |" >> $GITHUB_STEP_SUMMARY
            fi
          done
